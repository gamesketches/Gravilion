<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Gravilion</title>
    <script type="text/javascript" src="phaser.min.js"></script>
</head>
<body>

  <script type="text/javascript">
  var game = new Phaser.Game(800, 400, Phaser.AUTO, '', {preload: preload,
                                              create: create, update: update});

  var boundaries, bars, projectiles;
  var swordDamage = 2;
  var projectileDamage = 1, projectileSpeed = 5, angleChange = 0.2;
  var projectileCooldown = 15;
  var player1 = { lifeBar: null, airBar: null, life: 100, air: 100, sprite: null,
                    rounds: 0, swordHitBox: null, facingRight: true, gunHeat: 0, gunAngle: -1,
                    controls: null};
  var player2 = { lifeBar: null, airBar: null, life: 100, air: 100, sprite: null,
                    rounds: 0, swordHitBox: null, facingRight: false, gunHeat: 0, gunAngle: -1,
                    controls: null};

  function processInput(player) {
    var sprite = player.sprite;
    var gunHeat = player.gunHeat;
    var keys = player.controls;
    sprite.body.velocity.x = 0;

    if(keys.left.isDown) {
      sprite.body.velocity.x = -100;
      player.facingRight = false;
    }
    else if(keys.right.isDown) {
      sprite.body.velocity.x = 100;
      player.facingRight = true;
    }

    if((keys.up.isDown && sprite.body.gravity.y > 0) ||
        (keys.down.isDown && sprite.body.gravity.y < 0)) {
      sprite.body.gravity.y *= -1;
    }
    if(keys.projectile.isDown && player.gunAngle > 0){
      player.gunAngle += angleChange;
    }

  }

  function releaseShot(event) {
    if(event.keyCode == player1.controls.projectile.keyCode){
      player1.gunAngle = -1;
      fireShot(player1);
    }
    else if(event.keyCode == player2.controls.projectile.keyCode){
      player2.gunAngle = -1;
      fireShot(player2);
    }
  }

  function chargeShot(event){
    if(event.keyCode == player1.controls.projectile.keyCode){
      if(!player1.gunHeat)
        player1.gunAngle = 0;
    }
    else if(event.keyCode == player2.controls.projectile.keyCode){
      if(!player2.gunHeat)
        player2.gunAngle = 0;
    }
  }

  function fireShot(player) {
    var sprite = player.sprite;
    var projectileRect = game.make.bitmapData(100, 35);
    projectileRect.ctx.fillStyle = "#FF00FF";
    projectileRect.ctx.fillRect(0, 0, 100, 35);

    var projectile = player.facingRight ?
                          projectiles.create(sprite.body.x + sprite.body.width, sprite.body.y, projectileRect) :
                          projectiles.create(sprite.body.x, sprite.body.y, projectileRect);
    projectile.velocity = player.facingRight ? projectileSpeed : -projectileSpeed;

    player.gunHeat = projectileCooldown;
  }

  function preload() {
    player1.life = 100;
    player2.life = 100;
    player1.air = 100;
    player2.air = 100;
    game.load.image('sword', 'sword.png');
  }

  function create() {

    game.physics.startSystem(Phaser.Physics.ARCADE);

    boundaries = game.add.group();
    boundaries.enableBody = true;

    var vertBoundaries = game.make.bitmapData(800, 10);
    vertBoundaries.ctx.fillStyle = "#ff0000";
    vertBoundaries.ctx.fillRect(0, 0, 800, 10);

    var top = boundaries.create(0, 30, vertBoundaries, 0)
    top.body.immovable = true;
    var bottom = boundaries.create(0, 390, vertBoundaries, 0);
    bottom.body.immovable = true;

    var horBoundaries = game.make.bitmapData(10, 380);
    horBoundaries.ctx.fillStyle = "#ff0000";
    horBoundaries.ctx.fillRect(0, 0, 10, 390);

    var left = boundaries.create(0, 30, horBoundaries, 0);
    left.body.immovable = true;
    var right = boundaries.create(790, 30, horBoundaries, 0);
    right.body.immovable = true;

    var playerRect = game.make.bitmapData(35, 150);
    playerRect.ctx.fillStyle = "#00FF00";
    playerRect.ctx.fillRect(0, 0, 35, 150);

    player1.sprite = game.add.sprite(40, 240, playerRect);
    game.physics.arcade.enable(player1.sprite);
    player1.sprite.body.bounce.y = 0.2;
    player1.sprite.body.gravity.y = 300;

    player2.sprite = game.add.sprite(600, 40, playerRect);
    game.physics.arcade.enable(player2.sprite);
    player2.sprite.body.bounce.y = 0.2;
    player2.sprite.body.gravity.y = -300;

    var lifeBar = game.make.bitmapData(200, 10);
    lifeBar.ctx.fillStyle = "#d2b48c";
    lifeBar.ctx.fillRect(0, 0, 200, 10);

    var airBar = game.make.bitmapData(200, 10);
    airBar.ctx.fillStyle = "#b0d7e6";
    airBar.ctx.fillRect(0, 0, 200, 10);

    bars = game.add.group();

    player1.lifeBar = bars.create(10, 0, lifeBar, 0);
    player1.airBar = bars.create(10, 10, airBar, 0);
    player2.lifeBar = bars.create(550, 0, lifeBar, 0);
    player2.airBar = bars.create(550, 10, airBar, 0);

    player1.hitBox = game.add.sprite(player1.sprite.body.width, player1.sprite.body.height / 2, "sword");
    player2.hitBox = game.add.sprite(0, player2.sprite.body.height / 2, "sword");

    game.physics.enable(player1.hitBox, Phaser.Physics.ARCADE);
    game.physics.enable(player2.hitBox, Phaser.Physics.ARCADE);

    player2.hitBox.rotation = 3.1415926536;

    player1.sprite.addChild(player1.hitBox);
    player2.sprite.addChild(player2.hitBox);
    player1.hitBox.body.setSize(30, 10, player1.sprite.body.width, player1.sprite.body.height / 2);
    player2.hitBox.body.setSize(30, 10, -31, player2.sprite.body.height / 2);

    player2.controls = game.input.keyboard.createCursorKeys();
    player2.controls.projectile = game.input.keyboard.addKey(Phaser.Keyboard.P);

    player1.controls = {
      up: game.input.keyboard.addKey(Phaser.Keyboard.W),
      down: game.input.keyboard.addKey(Phaser.Keyboard.S),
      left: game.input.keyboard.addKey(Phaser.Keyboard.A),
      right: game.input.keyboard.addKey(Phaser.Keyboard.D),
      projectile: game.input.keyboard.addKey(Phaser.Keyboard.Q),
    };

    game.input.keyboard.addCallbacks(this, chargeShot, releaseShot, null);

    projectiles = game.add.group();
    projectiles.enableBody = true;

  }

  function update() {
    game.physics.arcade.collide(player1.sprite, boundaries);
    game.physics.arcade.collide(player2.sprite, boundaries);

    processInput(player1);
    processInput(player2);

    player1.air -= 0.05;
    if(player1.air < 0 || player1.life < 0) {
      game.state.start('p2Wins');
    }
    player2.air -= 0.05;
    if(player2.air < 0 || player2.life < 0) {
      game.state.start('p1Wins');
    }
    player1.airBar.scale.set(player1.air / 100, 1);
    player2.airBar.scale.set(player2.air / 100, 1);

    player1.lifeBar.scale.set(player1.life / 100, 1);
    player2.lifeBar.scale.set(player2.life / 100, 1);

    if(Phaser.Rectangle.intersects(player1.hitBox.getBounds(), player2.sprite.getBounds())) {
      player2.life -= swordDamage;
    }
    if(Phaser.Rectangle.intersects(player2.hitBox.getBounds(), player1.sprite.getBounds())) {
      player1.life -= swordDamage;
    }

    projectiles.forEach(
        function(child) {
          child.body.x += child.velocity;
          if(Phaser.Rectangle.intersects(player1.sprite.getBounds(), child.getBounds())){
            player1.life -= projectileDamage;
          }
          if(Phaser.Rectangle.intersects(player2.sprite.getBounds(), child.getBounds())){
            player2.life -= projectileDamage;
          }
        });
    player1.gunHeat -= 1;
    player2.gunHeat -= 1;
  }

  game.state.add('fight', { preload: preload, create: create, update: update});

  game.state.add('p1Wins', {
  			preload: function() {},
  			create: function (){
  							game.add.text(400, 300, 'Player 1 Wins', { fontSize: '32px', fill: '#FFF' });
  						  player1.rounds += 1;
                if(player1.rounds < 2){
                game.time.events.add(Phaser.Timer.SECOND * 2, function() {game.state.start('fight')}, this);
                }
              },
  			update: function() {}
  		});
  game.state.add('p2Wins', {
  	preload: function() {},
  	create: function (){
  					game.add.text(400, 300, 'Player 2 Wins', { fontSize: '32px', fill: '#FFF' });
  				  player2.rounds += 1;
            if(player2.rounds < 2) {
                  game.time.events.add(Phaser.Timer.SECOND * 2, function() { game.state.start('fight')}, this);
            }
          },
  	update: function() {}
  });

  </script>
</body>
</html>
