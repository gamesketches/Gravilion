<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Gravilion</title>
    <script type="text/javascript" src="phaser.min.js"></script>
</head>
<body>

  <script type="text/javascript">
  var game = new Phaser.Game(800, 400, Phaser.AUTO, '', {preload: preload,
                                              create: create, update: update});

  var boundaries, bars;
  var player1 = { lifeBar: null, airBar: null, life: 100, air: 100, sprite: null,
                    rounds: 0, swordHitBox: null};
  var player2 = { lifeBar: null, airBar: null, life: 100, air: 100, sprite: null,
                    rounds: 0, swordHitBox: null};

  function processInput(player, keys) {
    player.body.velocity.x = 0;

    if(keys.left.isDown) {
      player.body.velocity.x = -100;
    }
    else if(keys.right.isDown) {
      player.body.velocity.x = 100;
    }

    if((keys.up.isDown && player.body.gravity.y > 0) ||
        (keys.down.isDown && player.body.gravity.y < 0)) {
      player.body.gravity.y *= -1;
    }
  }

  function preload() {
    player1.life = 100;
    player2.life = 100;
    player1.air = 100;
    player2.air = 100;
    game.load.image('sword', 'sword.png');
  }

  function create() {

    game.physics.startSystem(Phaser.Physics.ARCADE);

    boundaries = game.add.group();
    boundaries.enableBody = true;

    var vertBoundaries = game.make.bitmapData(800, 10);
    vertBoundaries.ctx.fillStyle = "#ff0000";
    vertBoundaries.ctx.fillRect(0, 0, 800, 10);

    var top = boundaries.create(0, 30, vertBoundaries, 0)
    top.body.immovable = true;
    var bottom = boundaries.create(0, 390, vertBoundaries, 0);
    bottom.body.immovable = true;

    var horBoundaries = game.make.bitmapData(10, 380);
    horBoundaries.ctx.fillStyle = "#ff0000";
    horBoundaries.ctx.fillRect(0, 0, 10, 390);

    var left = boundaries.create(0, 30, horBoundaries, 0);
    left.body.immovable = true;
    var right = boundaries.create(790, 30, horBoundaries, 0);
    right.body.immovable = true;

    var playerRect = game.make.bitmapData(35, 150);
    playerRect.ctx.fillStyle = "#00FF00";
    playerRect.ctx.fillRect(0, 0, 35, 150);

    player1.sprite = game.add.sprite(40, 240, playerRect);
    game.physics.arcade.enable(player1.sprite);
    player1.sprite.body.bounce.y = 0.2;
    player1.sprite.body.gravity.y = 300;

    player2.sprite = game.add.sprite(600, 40, playerRect);
    game.physics.arcade.enable(player2.sprite);
    player2.sprite.body.bounce.y = 0.2;
    player2.sprite.body.gravity.y = -300;

    var lifeBar = game.make.bitmapData(200, 10);
    lifeBar.ctx.fillStyle = "#d2b48c";
    lifeBar.ctx.fillRect(0, 0, 200, 10);

    var airBar = game.make.bitmapData(200, 10);
    airBar.ctx.fillStyle = "#b0d7e6";
    airBar.ctx.fillRect(0, 0, 200, 10);

    bars = game.add.group();

    player1.lifeBar = bars.create(10, 0, lifeBar, 0);
    player1.airBar = bars.create(10, 10, airBar, 0);
    player2.lifeBar = bars.create(550, 0, lifeBar, 0);
    player2.airBar = bars.create(550, 10, airBar, 0);

    player1.hitBox = game.add.sprite(0, 0, "sword");
    player2.hitBox = game.add.sprite(0, 0, "sword");

    game.physics.enable(player1.hitBox, Phaser.Physics.ARCADE);
    game.physics.enable(player2.hitBox, Phaser.Physics.ARCADE);;

    player1.sprite.addChild(player1.hitBox);
    player2.sprite.addChild(player2.hitBox);
    player1.hitBox.body.setSize(30, 10, player1.sprite.width, player1.sprite.height / 2);
    player2.hitBox.body.setSize(30, 10, -31, player2.sprite.height / 2);

  }

  function update() {
    game.physics.arcade.collide(player1.sprite, boundaries);
    game.physics.arcade.collide(player2.sprite, boundaries);

    var p2Controls = game.input.keyboard.createCursorKeys();

    var p1Controls = {
      up: game.input.keyboard.addKey(Phaser.Keyboard.W),
      down: game.input.keyboard.addKey(Phaser.Keyboard.S),
      left: game.input.keyboard.addKey(Phaser.Keyboard.A),
      right: game.input.keyboard.addKey(Phaser.Keyboard.D),
    }

    processInput(player1.sprite, p1Controls);
    processInput(player2.sprite, p2Controls);

    player1.air -= 0.05;
    if(player1.air < 0) {
      game.state.start('p2Wins');
    }
    player2.air -= 0.05;
    if(player2.air < 0) {
      game.state.start('p1Wins');
    }
    player1.airBar.scale.set(player1.air / 100, 1);
    player2.airBar.scale.set(player2.air / 100, 1);

    player1.lifeBar.scale.set(player1.life / 100, 1);
    player2.lifeBar.scale.set(player2.life / 100, 1);
  }

  game.state.add('fight', { preload: preload, create: create, update: update});

  game.state.add('p1Wins', {
  			preload: function() {},
  			create: function (){
  							game.add.text(400, 300, 'Player 1 Wins', { fontSize: '32px', fill: '#FFF' });
  						  player1.rounds += 1;
                if(player1.rounds < 2){
                game.time.events.add(Phaser.Timer.SECOND * 2, function() {game.state.start('fight')}, this);
                }
              },
  			update: function() {}
  		});
  game.state.add('p2Wins', {
  	preload: function() {},
  	create: function (){
  					game.add.text(400, 300, 'Player 2 Wins', { fontSize: '32px', fill: '#FFF' });
  				  player2.rounds += 1;
            if(player2.rounds < 2) {
                  game.time.events.add(Phaser.Timer.SECOND * 2, function() { game.state.start('fight')}, this);
            }
          },
  	update: function() {}
  });

  </script>
</body>
</html>
